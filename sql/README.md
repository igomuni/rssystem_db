# 分析用SQLクエリ集 兼 分析ガイド

このフォルダには、`rs_database.duckdb` から特定の洞察（インサイト）を引き出すための、再利用可能なSQLクエリを格納します。

各SQLファイルは、`run_query.py` スクリプトを通じて実行できます。

```bash
# 例: check_expenditure_vs_budget_revised.sql を実行し、結果をCSVに出力
python ../run_query.py -q sql/check_expenditure_vs_budget_revised.sql -o expenditure_check.csv
```

---

## 分析ケーススタディ：巨大支出額の謎を追う

このデータベースの分析が、どのようにして新たな発見につながるかを示す実践的な例として、特定の事業における巨大な支出額の調査プロセスを以下に示します。

### 1. 発見：データの疑問点

`支出先_支出情報` テーブルを調査していると、「電気・ガス価格激変緩和対策等事業」において、株式会社博報堂へ**2.3兆円**という、単体の事業としては非現実的に見える支出額が記録されていることが発見された。

これはデータエラーか、それとも何か特殊な事業構造があるのか？

### 2. 仮説：代理人（Agent）モデルの存在

博報堂の実際の売上高と比較しても、この金額はあり得ない。ここから、**「この2.3兆円は博報堂の売上ではなく、事業全体の補助金原資を管理するための『預り金』であり、博報堂は事業全体の資金フローを管理する『事務局（代理人）』としての役割を担っているのではないか」**という仮説を立てた。

### 3. 検証：データに基づいた裏付け調査

この仮説を検証するために、データベース内の複数の情報を組み合わせる。

#### A) データ上の内部証拠の確認

1.  **役割の確認:** `支出先_支出情報` テーブルの `事業を行う上での役割` カラムを確認。
    *   **結果:** `事務局経費、小売事業者等への値引き原資の補助` と記載されており、博報堂が「事務局」であり、「補助金の原資」を扱っていることが直接的に示されていた。

2.  **資金フローの確認:** `支出先_支出ブロックのつながり` テーブルを調査。
    *   **分析:** 「事務局」を支出元とする資金の流れを追うことで、他の電力・ガス会社へ資金が再分配されている構造を確認できる。

3.  **予算額との比較:** 事業全体の予算と、個別の支出額を比較する。データの粒度の違いによる重複を避けるため、各テーブルで先に集計してから結合する高度なSQLクエリ (`check_expenditure_vs_budget_revised.sql`) を使用。
    *   **結果:** 事業全体の総予算額（約4.4兆円）のうち、**53.6%** がまず博報堂に渡っていることが判明。これにより、博報堂が事業の中核的な資金管理者であることが定量的に証明された。

#### B) 外部証拠による補強

データ分析で得た確信をさらに強固にするため、公開情報を検索する。

*   **検索キーワード:** `電気・ガス価格激変緩和対策事業 事務局 公募` など
*   **探すべき資料:** 事業の主務官庁（経済産業省 資源エネルギー庁）のウェブサイトにある**公募要領**や**事業概要資料**。
*   **結果:** これらの公式資料から、本事業が事務局を公募し、その事務局が補助金の執行管理を行うスキームであることが確認された。

### 4. 結論

データ分析と外部情報の両方から、2.3兆円という支出額はデータエラーではなく、**「国 → 事務局（博報堂）→ 各小売事業者」という代理人モデルの資金フローを正確に反映したものである**と結論付けられた。

---

## Looker Studioでのレポート作成ガイド

上記のような分析結果は、Looker Studioを使うことで、誰にでも分かりやすいインタラクティブなレポートとして共有できる。

**手順の概要:**
1.  **データソースの準備:**
    *   `run_query.py` を使い、レポートで可視化したい内容を集計したSQLクエリ（例: `summary_for_looker.sql`）を実行し、結果をCSVファイルとして出力する。
    *   出力したCSVファイルを、Google Driveで**Googleスプレッドシート**にインポートする。

2.  **Looker Studioでの接続:**
    *   Looker Studioで新しいレポートを作成し、データソースとして「Googleスプレッドシート」コネクタを選択。
    *   準備したスプレッドシートに接続する。

3.  **レポートの作成:**
    *   **スコアカード:** 「総予算額」や「事業数」といった重要な数値を大きく表示する。
    *   **棒グラフ/円グラフ:** 「府省庁別の予算額比較」や「支出先の内訳」など、構成比や比較を視覚的に表現する。
    *   **表:** 詳細なデータを確認できるよう、集計結果の表を配置する。
    *   **フィルタ:** 「年度」や「府省庁」でデータを絞り込めるインタラクティブなフィルタコントロールを追加すると、レポートの価値がさらに高まる。

4.  **共有:**
    完成したレポートは、URLを通じて関係者と簡単に共有できる。